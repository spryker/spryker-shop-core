{% extends model('component') %}

{% define config = {
    name: 'ordered-configured-bundle',
    tag: 'article',
} %}

{% define data = {
    bundle: required,
    items: [],
    currencyIsoCode: null,
} %}

{%- block extraClass %} spacing-bottom spacing-bottom--big{% endblock -%}

{% block body %}
    {% block bundle %}
        <div class="{{ config.name }}__content {{ config.name }}__container">
            {% block bundleInner %}
                {% block bundleGeneralInformation %}
                    <div class="{{ config.name }}__col col">
                        {% block bundleName %}
                            <h6 class="spacing-right spacing-right--big">
                                {%- block bundleNameText -%}
                                    {{ data.bundle.name | trans }}
                                {%- endblock -%}
                            </h6>
                        {% endblock %}
                    </div>
                {% endblock %}

                {% block bundleQuantity %}
                    <div class="{{ config.name }}__col col col--lg-4">
                        {% block bundleQuantityInner %}
                            {% include molecule('ordered-configured-bundle-quantity', 'SalesConfigurableBundleWidget') with {
                                data: {
                                    quantity: data.bundle.quantity,
                                },
                            } only %}
                        {% endblock %}
                    </div>
                {% endblock %}

                {% block bundlePriceInformation %}
                    <div class="{{ config.name }}__col col">
                        {% block bundleTotal %}
                            <strong class="{{ config.name }}__text">
                                {%- block bundleTotalInner -%}
                                    {% if can('SeePricePermissionPlugin') %}
                                        {%- block bundleTotalTitle -%}
                                            {{ 'configured_bundle.bundle_total' | trans }}
                                        {%- endblock %}

                                        {%- block bundleTotalValue -%}
                                            {% set bundleSumPriceToPayAggregation = 0 %}
                                            {% set currencyIsoCode = data.currencyIsoCode %}

                                            {% for item in data.bundle.salesOrderConfiguredBundleItems if data.items[item.IdSalesOrderItem] is defined %}
                                                {% set product = data.items[item.IdSalesOrderItem] %}
                                                {% set currencyIsoCode = product.currencyIsoCode %}
                                                {% set bundleSumPriceToPayAggregation = bundleSumPriceToPayAggregation + product.sumPriceToPayAggregation %}
                                            {% endfor %}

                                            {{ bundleSumPriceToPayAggregation | money(true, currencyIsoCode ?? data.currencyIsoCode) }}
                                        {%- endblock -%}
                                    {% else %}
                                        {{ 'customer.access.cannot_see_price' | trans }}
                                    {% endif %}
                                {%- endblock -%}
                            </strong>
                        {% endblock %}
                    </div>
                {% endblock %}
            {% endblock %}
        </div>
    {% endblock %}

    {% block bundleProductList %}
        <div class="{{ config.name }}__products">
            {% block bundleProductListInner %}
                {% set partialItemCount = 0 %}
                {% for item in data.bundle.salesOrderConfiguredBundleItems if data.items[item.IdSalesOrderItem] is defined %}
                    {% include molecule('ordered-configured-bundle-product', 'SalesConfigurableBundleWidget') with {
                        data: {
                            product: data.items[item.IdSalesOrderItem],
                            currencyIsoCode: item.currencyIsoCode ?? data.currencyIsoCode,
                            image: data.items[item.IdSalesOrderItem].metadata.image,
                        },
                    } only %}
                    {% set partialItemCount = partialItemCount + 1 %}
                {% endfor %}

                {{ 'configured_bundle_widget.items' | trans }} {{ partialItemCount }} / {{ data.bundle.salesOrderConfiguredBundleItems | length }}
            {% endblock %}
        </div>
    {% endblock %}

    {% block configurableBundleNote %}
        {% include molecule('readonly-bundled-note', 'ConfigurableBundleNoteWidget') ignore missing with {
            data: {
                bundle: data.bundle,
            },
        } only %}
    {% endblock %}
{% endblock %}
